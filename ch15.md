# ch15 구글 드라이브 설계

## 문제의 이해와 설계 범위 설정

### 기능

- 파일 추가
- 파일 다운로드
- 여러 단말 간 파일 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 파일 편집 혹은 삭제 시 알림 표시

### 비기능 요구사항

- 안정성
- 빠른 동기화
- 네트워크 대역폭
- 규모 확장성
- 높은 가용성

## 개략적 설계안 제시 및 동의 구하기

- 가장 간단한 서버 형태
    - 파일 업로드 다운로드를 담당할 웹 서버
    - 사용자 데이터 / 로그인 정보 / 파일 정보를 구분할 메타 데이터 베이스
    - 파일 저장소 시스템

### API

시스템에서 제공하는 API 종류

1. 파일 업로드 API
    - 단순 업로드
    - 이어 올리기 : 파일 사이즈가 크고 네트워크 이슈 가능성이 있는 경우
        - 절차
            1. 이어 올리기 URL을 받기 위한 최초 Requeust 전송
            2. 데이터를 업로드 하고 모니터링
            3. 장애 시 장애 발생 시점부터 업로드 재시작

2. 파일 다운로드 API
    - 갱신 히스토리를 가져올 파일 경로
    - 히스토리 길이 최대치

### 한 대 서버의 제약 극복

- 가용성 보장하는 저장소 구현
    - user_id 기준으로 샤딩하여 저장 
    - 저장소로 S3를 저장하는 대안 존재
- 추가 고려안 및 고려할 컴포넌트
    - 로드밸런서
    - 웹 서버
    - 메타 데이터 베이스 : SPOF 회피하기 위해 분리
    - 파일 저장소

### 동기화 충돌

- 동시에 업데이트 하는 경우?
    1. 하나로 합치기
    2. 대체하기

### 설계안

- 블록 저장소  
    - 여러 블록으로 나누어 저장 / 각 블록에는 고유한 해시 값을 할당
    - 블록들을 원래 순서대로 합쳐야 함 (드랍박스의 경우 최대 4MB)

- 클라우드 저장소
    - 파일은 블록 단위로 나뉘어 클라우드 저장소 보관

- 아카이빙 저장소
    -  비활성화된 데이터를 저장

- 로드밸런서
- 메타데이터 베이스
- 메타데이터 캐시
- 알림 서비스
    - 특정 이벤트가 발생했을 때 클라이언트에 알림 (최신 상태 유지)
- 오프라인 사용자 백업 큐
    - 

